<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz P2P de Clase (m√≠nimo)</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#f5f5f7; }
    .wrap { max-width: 880px; margin: 32px auto; background:#fff; border-radius: 12px; padding: 24px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .muted { color:#666; font-size:14px; margin-bottom:16px; }
    .row { display:flex; gap:12px; margin: 10px 0; align-items: center; }
    input[type=text], textarea { padding:10px 12px; border:1px solid #ccc; border-radius:8px; outline:none; flex:1; font-size:16px; }
    button { padding:10px 14px; border:0; background:#2563eb; color:#fff; border-radius:8px; cursor:pointer; }
    button.secondary { background:#10b981; }
    button.danger { background:#ef4444; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .card { border:1px solid #eee; border-radius:10px; padding:14px; margin:12px 0; background:#fafafa; }
    .chip { background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight:700; letter-spacing:1px; }
    .error { background:#fef2f2; color:#b91c1c; padding:10px; border-radius:8px; margin-top:10px; white-space:pre-wrap; }
    .ok { color:#059669; font-weight:600; }
    .list > div { padding:8px 0; border-bottom:1px dashed #e5e7eb; }
    .list > div:last-child { border-bottom:0; }
    .small { font-size:13px; color:#555; }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="root">Cargando‚Ä¶</div>
  </div>

  <!-- IMPORTANTE: data-presets="env,react" -->
  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useRef } = React;

    const genId = () => Math.random().toString(36).substr(2, 6).toUpperCase();
    const MSG = { QUESTION: 'QUESTION', ANSWER: 'ANSWER' };

    function App() {
      const [role, setRole] = useState(null);         // 'host' | 'student' | null
      const [peerId, setPeerId] = useState('');
      const [status, setStatus] = useState('idle');   // 'connecting' | 'connected' | 'connected-to-host' | 'error' | 'idle'
      const [errorMsg, setErrorMsg] = useState('');
      const [diag, setDiag] = useState('');

      const peerRef = useRef(null);
      const connectionsRef = useRef({});
      const hostConnRef = useRef(null);

      // Host state
      const [studentsCount, setStudentsCount] = useState(0);
      const [currentQuestion, setCurrentQuestion] = useState(null);
      const [liveAnswers, setLiveAnswers] = useState({});

      // Student state
      const [activeQuestion, setActiveQuestion] = useState(null);
      const [myAnswer, setMyAnswer] = useState(null);

      useEffect(() => () => { if (peerRef.current) peerRef.current.destroy(); }, []);

      // PeerJS + STUN/TURN para atravesar NAT
      const peerConfig = {
        host: '0.peerjs.com',
        port: 443,
        path: '/',
        secure: true,
        debug: 2,
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun.relay.metered.ca:80' },
            { urls: 'turn:global.relay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:global.relay.metered.ca:80?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:global.relay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turns:global.relay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' }
          ],
          iceTransportPolicy: 'all'
        }
      };

      const log = (m) => setDiag(p => (p ? p + "\n" + m : m));
      const niceErr = (e) => {
        if (!e) return 'Error desconocido de conexi√≥n.';
        if (e.type === 'unavailable-id') return 'El ID ya est√° en uso. Vuelve a crear la sala.';
        if (e.type === 'peer-unavailable') return 'No se encontr√≥ la sala del profesor. Verifica el ID.';
        if (String(e).includes('Lost connection') || e.type === 'server-error') return 'No se puede contactar con el servidor de conexi√≥n (posible bloqueo de red).';
        return 'Error de conexi√≥n: ' + (e.type || e.message || String(e));
      };

      const initPeer = (id = null) => {
        setStatus('connecting'); setErrorMsg(''); setDiag('');
        const peer = new Peer(id, peerConfig);

        peer.on('open', (id) => { setPeerId(id); setStatus('connected'); log('Peer abierto con ID: ' + id); });
        peer.on('disconnected', () => { log('Peer desconectado. Reintentando‚Ä¶'); try { peer.reconnect(); } catch {} });
        peer.on('close', () => log('Peer cerrado.'));
        peer.on('error', (e) => { console.error(e); setStatus('error'); setErrorMsg(niceErr(e)); log('ERROR: ' + (e?.type || '') + ' ' + (e?.message || e)); });

        peerRef.current = peer;
        return peer;
      };

      // ---- HOST ----
      const curQRef = useRef(null);
      useEffect(() => { curQRef.current = currentQuestion; }, [currentQuestion]);

      const startHosting = () => {
        const id = genId();
        const peer = initPeer(id);
        setRole('host');

        peer.on('connection', (conn) => {
          log('Alumno intent√≥ conectar: ' + conn.peer);
          conn.on('open', () => {
            connectionsRef.current[conn.peer] = conn;
            setStudentsCount(Object.keys(connectionsRef.current).length);
            log('Conexi√≥n abierta con ' + conn.peer);
            if (curQRef.current) conn.send({ type: MSG.QUESTION, payload: curQRef.current });
          });
          conn.on('data', (d) => { if (d.type === MSG.ANSWER) setLiveAnswers(p => ({ ...p, [conn.peer]: d.payload })); });
          conn.on('close', () => { delete connectionsRef.current[conn.peer]; setStudentsCount(Object.keys(connectionsRef.current).length); log('Conexi√≥n cerrada: ' + conn.peer); });
          conn.on('error', (e) => log('Error en conexi√≥n alumno: ' + (e?.message || e)));
        });
      };

      const broadcastQuestion = (text, options) => {
        const q = { id: Date.now(), text, options };
        setCurrentQuestion(q);
        setLiveAnswers({});
        const msg = { type: MSG.QUESTION, payload: q };
        Object.values(connectionsRef.current).forEach(c => { if (c.open) c.send(msg); });
      };

      const stopHosting = () => {
        if (peerRef.current) peerRef.current.destroy();
        setRole(null); setPeerId(''); setStatus('idle');
        setStudentsCount(0); setCurrentQuestion(null); setLiveAnswers({});
      };

      // ---- STUDENT ----
      const joinSession = (hostId) => {
        if (!hostId) return;
        setRole('student');
        const peer = initPeer();

        peer.on('open', () => {
          const conn = peer.connect(hostId.toUpperCase(), { reliable: true });
          conn.on('open', () => { setStatus('connected-to-host'); hostConnRef.current = conn; log('Alumno conectado al host.'); });
          conn.on('data', (d) => { if (d.type === MSG.QUESTION) { setActiveQuestion(d.payload); setMyAnswer(null); } });
          conn.on('close', () => { alert('El profesor ha cerrado la sesi√≥n.'); setStatus('idle'); setRole(null); setActiveQuestion(null); });
          conn.on('error', (e) => { setErrorMsg('Error conectando con la sala.'); log('Error data-conn alumno: ' + (e?.message || e)); });
        });
      };

      const sendAnswer = (i) => { if (hostConnRef.current?.open) { hostConnRef.current.send({ type: MSG.ANSWER, payload: i }); setMyAnswer(i); } };
      const leaveStudent = () => { if (peerRef.current) peerRef.current.destroy(); setRole(null); setActiveQuestion(null); setStatus('idle'); setPeerId(''); };

      // ---- UI m√≠nima ----
      if (role === 'host') return <HostView
        status={status} peerId={peerId} students={studentsCount}
        currentQuestion={currentQuestion} liveAnswers={liveAnswers}
        onSend={(t,o)=>broadcastQuestion(t,o)} onExit={stopHosting}
        errorMsg={errorMsg} diag={diag}
      />;

      if (role === 'student') return <StudentView
        status={status} errorMsg={errorMsg} diag={diag}
        question={activeQuestion} myAnswer={myAnswer}
        onAnswer={sendAnswer} onExit={leaveStudent}
      />;

      return <Landing onHost={startHosting} onJoin={joinSession} status={status} errorMsg={errorMsg} diag={diag} />;
    }

    function Landing({ onHost, onJoin, status, errorMsg, diag }) {
      const [code, setCode] = React.useState('');
      return (
        <div>
          <h1>üéì Aula Quiz P2P</h1>
          <div className="muted">Herramienta de preguntas en vivo sin servidor.</div>

          {status === 'connecting' && <div className="ok">Conectando‚Ä¶</div>}

          <div className="card">
            <div className="row">
              <button onClick={onHost} disabled={status==='connecting'}>Soy Profesor (Crear sala)</button>
            </div>
            <div className="row">
              <input type="text" value={code} onChange={e=>setCode(e.target.value.toUpperCase())} placeholder="ID de sala (p. ej. ABC123)" />
              <button className="secondary" onClick={()=>onJoin(code)} disabled={!code || code.length<4 || status==='connecting'}>Entrar como Alumno</button>
            </div>
            {errorMsg && <div className="error">{errorMsg}</div>}
            {diag && (
              <details style={{marginTop:'8px'}}><summary>Detalles t√©cnicos</summary><pre className="small">{diag}</pre></details>
            )}
          </div>
        </div>
      );
    }

    function HostView({ status, peerId, students, currentQuestion, liveAnswers, onSend, onExit, errorMsg, diag }) {
      const { useState } = React;
      const [text, setText] = useState('');
      const [opts, setOpts] = useState(['','']);
      const updateOpt = (i,v)=>{ const n=[...opts]; n[i]=v; setOpts(n); };
      const addOpt = ()=> setOpts(p=>[...p,'']);
      const rmOpt = (i)=> setOpts(p=>p.filter((_,ix)=>ix!==i));
      const launch = ()=>{
        const clean = opts.map(s=>s.trim()).filter(Boolean);
        if (!text.trim() || clean.length<2) { alert('Escribe la pregunta y al menos 2 opciones.'); return; }
        onSend(text.trim(), clean);
      };

      const total = Object.keys(liveAnswers).length;

      return (
        <div>
          <h1>Panel de Profesor</h1>
          <div className="row small">
            <div>ID de Sala:&nbsp;{status==='connected' ? <span className="chip">{peerId}</span> : 'Generando‚Ä¶'}</div>
            <div style={{marginLeft:'auto'}}>Alumnos conectados: <b>{students}</b></div>
          </div>

          <div className="card">
            <div style={{marginBottom:8}}><b>Nueva pregunta</b></div>
            <textarea rows="3" placeholder="Escribe tu pregunta‚Ä¶" value={text} onChange={e=>setText(e.target.value)}></textarea>
            <div className="list">
              {opts.map((o, i)=>(
                <div key={i} className="row">
                  <span className="small" style={{width:24}}>{String.fromCharCode(65+i)}.</span>
                  <input type="text" placeholder={`Opci√≥n ${i+1}`} value={o} onChange={e=>updateOpt(i,e.target.value)}/>
                  {opts.length>2 && <button className="danger" onClick={()=>rmOpt(i)}>Eliminar</button>}
                </div>
              ))}
            </div>
            <div className="row">
              <button onClick={addOpt}>A√±adir opci√≥n</button>
              <div style={{flex:1}}></div>
              <button className="secondary" onClick={launch}>Lanzar a la clase</button>
              <button className="danger" onClick={onExit}>Salir</button>
            </div>
          </div>

          <div className="card">
            <div style={{marginBottom:8}}><b>Resultados en vivo</b></div>
            {!currentQuestion ? (
              <div className="muted">A√∫n no hay pregunta.</div>
            ) : (
              <div>
                <div style={{margin:'6px 0'}}><b>{currentQuestion.text}</b></div>
                <div className="list">
                  {currentQuestion.options.map((opt, idx)=>{
                    const count = Object.values(liveAnswers).filter(a => a === idx).length;
                    const pct = total>0 ? Math.round((count/total)*100) : 0;
                    return (
                      <div key={idx}>
                        <div className="row" style={{justifyContent:'space-between'}}>
                          <div>{String.fromCharCode(65+idx)}. {opt}</div>
                          <div><b>{count}</b> ({pct}%)</div>
                        </div>
                        <!-- ¬°ARREGLO AQU√ç!: style como OBJETO, no cadena -->
                        <div style={{height:'8px', background:'#eee', borderRadius:'6px', overflow:'hidden'}}>
                          <div style={{height:'8px', width:pct+'%', background:'#2563eb'}}></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="small" style={{marginTop:6}}>Total respuestas: <b>{total}</b></div>
              </div>
            )}
          </div>

          {errorMsg && <div className="error">{errorMsg}</div>}
          {diag && <details style={{marginTop:'8px'}}><summary>Detalles t√©cnicos</summary><pre className="small">{diag}</pre></details>}
        </div>
      );
    }

    function StudentView({ status, errorMsg, diag, question, myAnswer, onAnswer, onExit }) {
      if (status === 'connecting' || (status === 'connected-to-host' && !question)) {
        return (
          <div>
            <h1>Alumno</h1>
            <div className="muted">Conectando / esperando primera pregunta‚Ä¶</div>
            {errorMsg && <div className="error">{errorMsg}</div>}
            {diag && <details style={{marginTop:'8px'}}><summary>Detalles t√©cnicos</summary><pre className="small">{diag}</pre></details>}
            <div className="row"><button className="danger" onClick={onExit}>Salir</button></div>
          </div>
        );
      }
      if (!question) {
        return <div><h1>Alumno</h1><div className="muted">Esperando pregunta‚Ä¶</div><div className="row"><button className="danger" onClick={onExit}>Salir</button></div></div>;
      }
      return (
        <div>
          <h1>Alumno</h1>
          <div className="card">
            <div className="small">Pregunta actual</div>
            <div style={{fontWeight:700, margin:'6px 0'}}>{question.text}</div>
            <div className="list">
              {question.options.map((opt, idx) => {
                const isSelected = myAnswer === idx;
                return (
                  <div key={idx} className="row">
                    <button onClick={()=>onAnswer(idx)} disabled={myAnswer!==null} style={{background:isSelected?'#1d4ed8':'#2563eb'}}>
                      {String.fromCharCode(65+idx)}
                    </button>
                    <div className="small" style={{fontSize:'16px'}}>{opt}</div>
                  </div>
                );
              })}
            </div>
            {myAnswer!==null && <div className="ok">Respuesta enviada ‚úÖ</div>}
          </div>
          <div className="row"><button className="danger" onClick={onExit}>Salir</button></div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
